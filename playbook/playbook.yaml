---

- name: Configure Workstation
  hosts: localhost
  vars:
    # Pinned tool versions
    # Update these values to change the versions installed by the playbook.
    # You can override these at runtime when running the playbook, for example:
    #   sudo ansible-playbook playbook/playbook.yaml -e "terraform_version=1.6.0 vault_version=1.15.0"
    # Keep in mind some tools may require additional compatibility checks when bumping.
    user: "{{ lookup('env','USER') }}"
    user_windows_path: "/mnt/c/Users/{{ lookup('env','USERNAME') | default(lookup('env','USER')) }}"
    terraform_version: 1.9.8
    vault_version: 1.17.2
    kind_version: 0.20.0
    # Note: other tool versions (helm, k9s, octant, etc.) are currently hardcoded
    # in `playbook/kube-tools.yaml`. If you want to make those configurable, move
    # their version strings here and reference the variables in that task file.
  tasks:
    - name: Detect WSL
      command: grep -i microsoft /proc/version
      register: wsl_check
      ignore_errors: yes
      changed_when: false

    - name: Set is_wsl fact
      set_fact:
        is_wsl: "{{ wsl_check.rc == 0 }}"

    - name: Install base required packages
      apt:
        pkg:
        - curl
        - wget
        - unzip
        - jq
        - bash-completion
        - git
        - software-properties-common
        - python3
        - python3-pip
        - xdg-utils
        state: latest
  
    - name: Install Terraform
      unarchive:
        src: https://releases.hashicorp.com/terraform/{{ terraform_version }}/terraform_{{ terraform_version }}_linux_amd64.zip
        dest: /usr/local/bin
        remote_src: True
    
    - name: Install Vault
      unarchive:
        src: https://releases.hashicorp.com/vault/{{ vault_version }}/vault_{{ vault_version }}_linux_amd64.zip
        dest: /usr/local/bin
        remote_src: True
    
    - name: Create wsl.conf
      # Creates config file for WSL that sets drives to automount at root / instead of /mnt
      # https://itnext.io/setting-up-the-kubernetes-tooling-on-windows-10-wsl-d852ddc6699c
      copy:
        dest: "/etc/wsl.conf"
        content: |
          [automount]
          root = /
          options = "metadata"
      when: is_wsl
          
    - name: Configure Git Credential manager
      git_config:
        name: credential.helper
        scope: global
        value: /c/Program\ Files/Git/mingw64/libexec/git-core/git-credential-manager.exe
      when: is_wsl

#    - name: Configure Git config (optional - uncomment and customize)
#      git_config:
#        name: user.email
#        scope: global
#        value: your.email@example.com
#
#    - name: Configure Git config user name (optional - uncomment and customize)
#      git_config:
#        name: user.name
#        scope: global
#        value: yourusername

#    - import_tasks: awscli.yaml        
    - import_tasks: python.yaml
    - import_tasks: powershell.yaml
    - import_tasks: kube-tools.yaml
    - import_tasks: azurecli.yaml

    - name: Remove useless packages from the cache
      apt:
        autoclean: yes

    - name: Remove dependencies that are no longer required
      apt:
        autoremove: yes
